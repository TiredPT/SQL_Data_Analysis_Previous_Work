## GROUP HEALTH: Sunsets per wk (last 12wks)

## Finds how many groups have ended per week

WITH SunsettingGroups AS (

select    
    g.id as groupId,
    g.name as groupName,
    DATE(g.startDate) as startDate,
    DATE(g.endDate) as endDate,
    DATE_SUB(DATE(g.endDate), INTERVAL DAYOFWEEK(g.endDate)-1 DAY) as endDateWeek
from 
    grps g 
where 
    g.startDate IS NOT NULL and 
    g.endDate IS NOT NULL 

order by
    g.startDate desc
)

select

    sg.endDateWeek as 'Week Cohort',
    COUNT(sg.groupName) as "Sunsetting by EOW"

from 
    SunsettingGroups sg 

where
    sg.endDateWeek <= NOW()

group by 
    sg.endDateWeek 

order by 
    sg.endDateWeek desc  

LIMIT 12
