## GROUP HEALTH: Active Groups (last 7 days)

## This query finds the total number of active groups in the last 7 days

WITH SunsettingGroups AS (

select    
    g.id as groupId,
    g.name as groupName,
    DATE(g.startDate) as startDate,
    DATE(g.endDate) as endDate,
    DATE_SUB(DATE(g.endDate), INTERVAL DAYOFWEEK(g.endDate)-1 DAY) as endDateWeek
from 
    grps g 
where 
    g.startDate IS NOT NULL and 
    g.endDate IS NOT NULL

    # We need to get Groups to exclude internal and other random groups.
        AND g.isInternal is not true 
        AND g.skipInMetrics != 1 
        AND g.groupTypeId != 'proprietary link1'
        AND g.groupTypeId != 'proprietary link2'
        AND g.groupTypeId != 'proprietary link3'
        AND g.id != 'proprietary link4'
        AND g.id != 'proprietary link5'
        AND g.id != 'proprietary link6' 

order by
    g.startDate desc
)

select

    sg.endDateWeek as 'Week Cohort',
    COUNT(sg.groupName) as "Sunsetting by EOW"

from 
    SunsettingGroups sg 

where
    sg.endDateWeek <= NOW()

group by 
    sg.endDateWeek 

order by 
    sg.endDateWeek desc  

LIMIT 12
