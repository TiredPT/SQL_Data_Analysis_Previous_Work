## GROUP HEALTH: Groups by session tenure

## Finds the groups and respective session tenure

WITH GroupSessions as (
    
    select 
        s.groupId as groupId,
        CASE 
             WHEN ROW_NUMBER() OVER(PARTITION BY g.id ORDER BY s.date ASC) = 1 THEN "L1"
             WHEN ROW_NUMBER() OVER(PARTITION BY g.id ORDER BY s.date ASC) between 2 and 13 THEN "L2-L12"
             ELSE "L13+"
             END as tenure,

        CONCAT('https://pace.group/admin/group/',g.id) as groupLink,
        g.name as groupName,
        DATE(s.date) as sessionDate,
        s.start as sessionStartTime,
        ROW_NUMBER() OVER(PARTITION BY g.id ORDER BY s.date ASC) AS nthGroupSession,
        DATE_SUB(DATE(s.date), INTERVAL DAYOFWEEK(s.date)-1 DAY) as weekCohort

    from sess s
    join grps g on g.id = s.groupId 

    where
        s.start <= NOW() and 
        g.startDate IS NOT NULL

    group by   
        s.id 

    order by 
        s.date desc  
    
)

select
   gs.weekCohort as 'Week Cohort',
   SUM(case when gs.Tenure = "L1" then 1 else 0 end) as "L1",
   SUM(case when gs.Tenure = "L2-L12" then 1 else 0 end) as "L2-L12",
   SUM(case when gs.Tenure = "L13+" then 1 else 0 end) as "L13+",
   COUNT(gs.Tenure) as "Weekly Total"

from 
    GroupSessions gs 
group by
    gs.weekCohort
 
order by 
    gs.weekCohort desc 

LIMIT 12 
